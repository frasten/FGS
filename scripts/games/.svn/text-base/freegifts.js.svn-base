var giftsArray = {
	'201278444497':
	{
		"gift_mystery1": { name: 'Mystery Gift 1'},
		"gift_mystery2": { name: 'Mystery Gift 2'},
		"gift_mystery3": { name: 'Mystery Gift 3'},
		"gift_mystery4": { name: 'Mystery Gift 4'},
		"feast_roastturkey" : { name: 'Roast Turkey'},
		"feast_cranberrysauce" : { name: 'Cranberry Sauce'},
		"feast_gravyboat" : { name: 'Gravy Boat'},
		"feast_pie" : { name: 'Pie'},
		"feast_sweetpotatoes" : { name: 'Sweet potatoes'},
		//"table_silverware" : { name: 'Silverware'},
		
		
		
		"meal1": { name: 'Light snack'},
		"meal2": { name: 'Breakfast (lvl 15)'},
		"meal3": { name: 'Lunch (lvl 40)'},
		"meal4": { name: 'Dinner (lvl 100)'},
		"ribbon": { name: 'Ribbon'},
		"hammer": { name: 'Hammer'},
		"nails": { name: 'Nails'},
		"bricks": { name: 'Brick'},
		"hand_drill": { name: 'Hand Drill'},
		"paint_bucket": { name: 'Paint Bucket'},
		"slate": { name: 'Slate'},
		"pen": { name: 'Ink Pen'},
		"ink": { name: 'Ink Well'},
		"spitball": { name: 'Spitball'},
		"chalk": { name: 'Chalk'},
		"chicken": { name: 'Chicken'},
		"cherryfront": { name: 'Cherry Tree'},
		"goat": { name: 'Goat'},
		"pinefront": { name: 'Pine Tree'},
		"sheep": { name: 'Sheep (lvl 8)'},
		"applefront": { name: 'Apple Tree (lvl 8)'},
		"goose": { name: 'Goose (lvl 10)'},
		"pig": { name: 'Pig (lvl 12)'},
		"pearfront": { name: 'Pear Tree (lvl 24)'},
		"peachfront": { name: 'Peach Tree (lvl 24)'},
		"apricotfront": { name: 'Apricot Tree (lvl 30)'},
		"cow": { name: 'Cow (lvl 18)'},
		"ox": { name: 'Ox (lvl 23)'},
		"bucket": { name: 'Bucket'},
		"hay": { name: 'Hay bale'},
		"opencrate": { name: 'Open Crate'},
		"straightfence": { name: 'Fence'},
		"smallflowers_blue": { name: 'Blue Flowers'},
		"cobblestone_border_thin": { name: 'Thin Cobblestone'},
		"smallflowers_yellow": { name: 'Yellow Flowers'},
		"flowerbed_small": { name: 'Small Flowerbed'},
		"cobblestone_border": { name: 'Stone Border'},
		"flowerpot_round": { name: 'Round Flower Pot'},
		"picnic_basket": { name: 'Picnic Basket'},
	},
	'102452128776':
	{
		"mysterygift": { name: 'Mystery Gift'},
		"socialplumbingmysterygift": { name: 'Special Delivery' },
		"shovel_item_01": { name: '2 Shovels'},
		
		"fruitcake": { name: 'Fruit Cake' },
		"spicedcider": { name: 'Spiced Cider' },
		"leafcandle": { name: 'Leaf Candle' },
		"stuffing": { name: 'Stuffing' },
		"casserole": { name: 'Casserole' },
		
		
		"roseblack_seedpackage": { name: '20 Black Rose Seeds'},
		"reindeer_randall": { name: 'Clumsy Reindeer'},
		"mumsyellow": { name: 'Yellow Mums' },
		
		
		"vehiclepart": { name: 'Vehicle Part'},
		"brick": { name: 'Brick'},
		"woodenboard": { name: 'Wooden Board'},
		"nail": { name: 'Nail'},		
		"beehive_bee": { name: 'Honeybee'},
		"smoker": { name: 'Smoker'},		
		"beeswax": { name: 'Beeswax'},
		"roseblack_seedpackage": { name: '20 Black Rose Seeds'},
		"wateringcan": { name: 'Watering Can'},
		"horseshoe": { name: 'Horseshoe'},
		"harness": { name: 'Harness'},
		"blanket": { name: 'Blanket'},
		"bottle": { name: 'Bottle'},
		
		"needlepointfarmhouse": { name: 'Needlepoint'},
		"dragonfly": { name: 'Dragonfly'},
		"gloves": { name: 'Gloves'},
		"purpleemperorbutterfly": { name: 'Emperor Butterfly'},
		"greenfeather": { name: 'Green Plume'},
		"fallacorn": { name: 'Acorn'},
		"fallmapleleaf": { name: 'Maple Leaf'},
		"fallpumpkin": { name: 'Pumpkin'},
		"fallcornucopia": { name: 'Cornucopia'},
		"fallharvestmoontoken": { name: 'Moon Token'},
		"fallturkeyfeather": { name: 'Feather'},

		"consume_kibble": { name: 'Puppy Kibble'},
		"consume_treat": { name: 'Dog Treat'},

		"hilltiny": { name: 'Small Hill'},
		"hangingflowers": { name: 'Hanging Flower'},
		"fencemodern": { name: 'Black Iron Fence'},
		"treemagnolia": { name: 'Magnolia Tree'},
		"goose": { name: 'Brown Goose'},
		"fencemarvinpicket": { name: 'Picket Fence II'},
		"haybaleroundjetblack": { name: 'Jet Black Hay '},
		"haybaleroundorange": { name: 'Orange Round Hay'},
		"plantersingle": { name: 'Tropical Planter'},
		"benchmodernblue": { name: 'Blue Bench'},
		"fencewhite": { name: 'Whitewash Fence'},
		"leavesmaple02": { name: 'Red Maple Leaves'},
		"maple02": { name: 'Red Maple Tree'},
		"maple03": { name: 'Yellow Maple Tree (lvl 4)'},
		"gulmohar": { name: 'Gulmohar Tree'},
		"haybaleroundviolet": { name: 'Purple Round Hay'},
		"cow": { name: 'Cow'},
		"chicken": { name: 'Chicken (lvl 4)'},
		"haystack": { name: 'Haystack'},
		"leavesmaple03": { name: 'Yellow Maple Leaves'},
		"sheep": { name: 'Sheep (lvl 7)'},
		"rabbit": { name: 'Rabbit (lvl 12)'},
		"banana": { name: 'Banana (lvl 14)'},
		"duck": { name: 'Duck (lvl 15)'},
		"tamarind": { name: 'Tamarind Tree (lvl 15)'},
		"pig": { name: 'Pig (lvl 10)'},
		"goat": { name: 'Goat (lvl 18)'},
		"date": { name: 'Date (lvl 20)'},
		"horse": { name: 'Horse (lvl 21)'},
		"olive": { name: 'Olive (lvl 32)'},
		"mango": { name: 'Mango (lvl 40)'},
		"azeleaorange": { name: 'Azaleas (lvl 50)'},
		"ginkgo": { name: 'Ginkgo (lvl 60)'},
		"floralcontainer": { name: 'Floral Container(lvl 70)'},
		"treemangrove": { name: 'Mangrove (lvl 80)'},
		"rabbit_dutch": { name: 'Dutch Rabbit (lvl 90)'},
		"jacarandatree": { name: 'Jacaranda (lvl 100)'},

		"cranberrybushel": { name: 'Cranberry (B.S.W)'},
		"blueberrybushel": { name: 'Blueberry (B.S.W)'},
		"strawberrybushel": { name: 'Strawberry (B.S.W)'},
		"blackberrybushel": { name: 'Blackberry (B.S.W)'},
		"basilbushel": { name: 'Basil (B.S.W)'},
		"pumpkinbushel": { name: 'Pumpkin (B.S.W)'},
		"pepperbushel": { name: 'Pepper (B.S.W)'},
		"gingerbushel": { name: 'Ginger (B.S.W)'},
		"sugarcanebushel": { name: 'SugarCane (B.-.W)'},
		"carrotbushel": { name: 'Carrot (B.-.W)'},
		"ricebushel": { name: ' Rice  (B.-.W)'},
		"tomatobushel": { name: 'Tomato (B.-.W)'},
		"raspberrybushel": { name: 'Raspberry (B.-.W)'},
		"coffeebushel": { name: 'Coffee (B.S.-)'},
		"ghostchilibushel": { name: 'GhostChili (B.S.-)'},
		"sunflowerbushel": { name: 'Sunflower (-.S.W)'},
		"morningglorybushel": { name: 'MorningGlory (-.S.W)'},
		"greenteabushel": { name: 'Green Tea (-.S.W)'},
		"lilacbushel": { name: ' Lilac  (-.S.W)'},
		"lavenderbushel": { name: 'Lavender (-.S.W)'},
		"pinkrosebushel": { name: 'Pink Rose (-.S.W)'},
		"pattypanbushel": { name: 'Pattypan (B.-.-)'},
		"wheatbushel": { name: ' Wheat   (B.-.-)'},
		"bluecornbushel": { name: 'PosoleCorn (B.-.-)'},
		"peasbushel": { name: '  Peas   (B.-.-)'},
		"oatsbushel": { name: '  Oats   (B.-.-)'},
		"broccolibushel": { name: 'Broccoli (B.-.-)'},
		"redwheatbushel": { name: 'RedWheat (B.-.-)'},
		"asparagusbushel": { name: 'Asparagus (B.-.-)'},
		"peanutsbushel": { name: 'Peanuts (B.-.-)'},
		"soybeansbushel": { name: 'Soybeans (B.-.-)'},
		"cucumberbushel": { name: 'Cucumber (B.-.-)'},
		"potatobushel": { name: 'Potatoes (B.-.-)'},
		"onionbushel": { name: 'Onion (B.-.-)'},
		"aloeverabushel": { name: 'AloeVera (-.S.-)'},
		"redtulipbushel": { name: 'RedTulip (-.S.-)'},
		"lilybushel": { name: '  Lily   (-.S.-)'},
		"irisbushel": { name: '  Iris   (-.S.-)'},
		"lemonbalmbushel": { name: 'LemonBalm (-.S.-)'},
		"poppypurplebushel": { name: 'PurplePoppies (-.S.-)'},
		"daffodilbushel": { name: 'Daffodils (-.S.-)'},
		"grapewhitebushel": { name: 'WhiteGrapes (-.-.W)'},
		"grapebushel": { name: '  Grapes   (-.-.W)'},
		"acornsquashbushel": { name: 'AcornSquash (-.-.W)'},
		"yellowmelonbushel": { name: 'YellowMelon (-.-.W)'},
		"watermelonbushel": { name: 'Watermelon (-.-.W)'},
	},
	'234860566661':
	{
		"mystery_gift": { name: 'Mystery Gift'},
		"fishing_bait_uncommon": { name: 'Good Bait'},
		"fishing_bait_common": { name: 'Basic Bait'},
		"key_excavations": { name: 'Golden Ticket (lvl 4)'},
		"halloween_treat": { name: 'Halloween Treat'},
		"halloween_trick_10": { name: 'Apple Core'},
		"halloween_trick_3": { name: 'Trick Candy'},
		"halloween_trick_5": { name: 'Circus peanuts'},
		"construction_gears": { name: 'Gears'},
		"construction_rock": { name: 'Rock'},
		"construction_aquavitae": { name: 'Aqua Vitae'},
		"construction_marble": { name: 'Marble'},
		"construction_nails": { name: 'Nails'},
		"construction_cloth": { name: 'Cloth'},
		"construction_fire": { name: 'Fire'},
		"construction_metal": { name: 'Metal'},
		"construction_oil": { name: 'Oil'},
		"construction_bolts": { name: 'Bolts'},
		"construction_dye": { name: 'Dye'},
		"construction_glue": { name: 'Glue'},
		"construction_rope": { name: 'Rope'},
		"construction_seed": { name: 'Seeds'},
		"construction_paint": { name: 'Paint'},
		"construction_plank": { name: 'Planks'},
		"construction_ectoplasm": { name: 'Ectoplasm'},
		"construction_pillar": { name: 'Pillars'},
		"construction_resin": { name: 'Resin'},
		"construction_shell": { name: 'Shells'},
		"construction_gold": { name: 'Gold'},
		"coins_gift_100": { name: '100 coins'},
		"map_fragment": { name: 'Map Fragment (lvl 15)'},
		"fruit_chocolatebar": { name: 'Monka Bar'},
		"gem_orange": { name: 'Orange Gem'},
		"gem_green": { name: 'Green Gem'},
		"gem_purple": { name: 'Purple Gem'},
		"gem_red": { name: 'Red Gem'},
		"gem_blue": { name: 'Blue Gem'},
		"fruit_kiwi": { name: 'Kiwis (lvl 3)'},
		"fruit_banana": { name: 'Bananas (lvl 10)'},
		"fruit_mango": { name: 'Mangoes (lvl 15)'},
		"fruit_lavamango": { name: 'Lava Mango'},
		"deco_poppyfield": { name: 'Poppyfield'},
		"deco_mnkpillar": { name: 'Short Pillar'},
		"deco_happyyellowflower": { name: 'Yellow Flower'},
		"deco_happypinkflower": { name: 'Pink Flower'},
		"deco_mnkpillartall": { name: 'Tall Pillar'},
		"deco_tallpillarvertical": { name: 'Torch Pillar'},
		"animal_plover": { name: 'Plover'},
		"deco_royalmnkpostrope2": { name: 'Royal Post Endcap'},
		"deco_royalmnkpostrope": { name: 'Royal Post'},
		"shrub_redbeachplant": { name: 'Red Beach Plant'},
	},
	'101539264719':
	{
		"2548": { name: 'Special Delivery'},
		"2714": { name: 'Tassimo Coffee'},
		"1174": { name: 'Spice Shelf'},
		"1177": { name: 'Spice Small Jar'},
		"1875": { name: 'Lotto Ticket'},
		"1836": { name: 'Tesla Coil'},
		"1835": { name: 'Science Book'},
		"1837": { name: 'Small Energy Boost'},
		"2266": { name: 'Pita and Dolmas'},
		"2404": { name: 'Ranch Beans'},
		"2450": { name: 'Tempura Udon'},
		"2480": { name: 'Pan Dulce'},
		"2773": { name: 'Tea Party'},
		"2540": { name: 'In Flight Meal'},
		"2677": { name: 'Skull Cookies'},
		"2774": { name: 'Drink Me Elixir'},
		"2541": { name: 'Sky Nuts'},
		"1793": { name: 'Falafel'},
		"1600": { name: 'Spring Rolls'},
		"1559": { name: 'Popcorn Shrimp'},
		"601": { name: 'Kung Pao Stir Fry'},
		"473": { name: 'Tahitian Punch'},
		"603": { name: 'Overstuffed Peppers'},
		"638": { name: 'Lucky Fortune Cookie'},
	}	
};


var freeGiftForGame =
{
	201278444497: 'meal1',
	102452128776: 'brick',
	234860566661: 'construction_gears',
	101539264719: '2548',
}

function ListNeighbours(gameID)
{
	var game = gamesData[gameID].systemName;
	
	var params = {
		gift: freeGiftForGame[gameID],
		gameID:	gameID
	};
	
	if(options.games[gameID].enabled)
	{
		if(gameID == '101539264719')
			eval(game+'Freegifts.Click(params)');
		else
			eval(game+'GetZyngaVars(params)');
	}
}


function cafeworldGetZyngaVars(params, retry)
{
	cafeworldFreegifts.Click(params);
}



function treasureGetZyngaVars(params, retry)
{
	if(typeof(retry) !== 'undefined')
	{
		var params2 = '_fb_noscript=1';
	}
	else
	{
		var params2 = '';
	}
	
	$.get('http://apps.facebook.com/treasureisle/', 'crt=&aff=tab&src=direct&newUser=&sendkey=&ref=tab', function(data)
	{
		try
		{
			i1          =   data.indexOf('post_form_id:"')
			if (i1 == -1) throw {message:'Cannot post_form_id in page'}
			i1			+=	14;
			i2          =   data.indexOf('"',i1);
			
			params.post_form_id = data.slice(i1,i2);
			
			
			i1          =   data.indexOf('fb_dtsg:"',i1)
			if (i1 == -1) throw {message:'Cannot find fb_dtsg in page'}
			i1			+=	9;
			i2          = data.indexOf('"',i1);
			params.fb_dtsg		= data.slice(i1,i2);
		}
		catch(e)
		{
			console.log(getCurrentTime()+'[Z] Error: '+e.message);
			
			if(typeof(params.sendTo) == 'undefined')
			{
				sendView('errorUpdatingNeighbours');
			}
			else
			{
				sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
			}
		}
		
		var nextUrl = '';
		
		$('iframe', data).each(function()
		{
			var testData = $(this).attr('src');
			if(typeof(testData) == 'undefined')	 return;
			
			
			if(testData.indexOf('treasure.zynga.com/flash.php') != -1)
			{
				nextUrl = $(this).attr('src');
				return false;
			}
		});
		
		if(nextUrl == '')
		{
			if(typeof(retry) == 'undefined')
			{
				treasureGetZyngaVars(params, true);
			}
			else
			{
				sendView('errorUpdatingNeighbours');
			}
			return;
		}
		
		
		$.get(nextUrl, params2, function(data){
			try
			{
				var re = new RegExp('^(?:f|ht)tp(?:s)?\://([^/]+)', 'im');
				var domain = nextUrl.match(re)[1].toString();

				var i1 = data.indexOf('new ZY({');
				if (i1 == -1) throw {message:'Cannot zyparams in page'}
				i1 += 7;
				i2 = data.indexOf('"},', i1)+2;
				var dataStr	= data.slice(i1,i2);				
				
				eval('var dataStrTmp = '+dataStr);
				
				params.zyParam = jQuery.param(dataStrTmp);
				
				
				console.log(getCurrentTime()+'[Z] Zynga params updated');
				
				
				
				$.get('http://'+domain+'/gifts_send.php?overlayed=1&gift='+params.gift+'&'+unescape(params.zyParam), '', function(data)
				{
					try 
					{
						var i1,i2, myParms;
						var strTemp = data;

						i1       =  strTemp.indexOf('FB.init("');
						if (i1 == -1) throw {message:"Cannot find FB.init"}
						i1 += 9;
						i2       =  strTemp.indexOf('"',i1);

						myParms  =  'app_key='+strTemp.slice(i1,i2);
						i1     =  i2 +1;
						i1       =  strTemp.indexOf('"',i1)+1;
						i2       =  strTemp.indexOf('"',i1);
						
						myParms +=  '&channel_url='+ encodeURIComponent(strTemp.slice(i1,i2));

						i1       =  strTemp.indexOf('<fb:fbml>');
						i2       =  strTemp.indexOf('/script>',i1)-1;
						myParms +=  '&fbml='+encodeURIComponent(strTemp.slice(i1,i2));
						
						i1 		 =  strTemp.indexOf(' exclude_ids="');
						if (i1 == -1)
							var exclArr = [];
						else
						{
							i2 = strTemp.indexOf('"', i1+14);
							eval('var exclArr = ['+strTemp.slice(i1+14, i2)+']');
						}
						
						params.exclude = exclArr;
						params.myParms = myParms;
						
						getFBML(params);
						
					}
					catch(e)
					{
						console.log(getCurrentTime()+'[Z] Error: '+e.message);
						if(typeof(params.sendTo) == 'undefined')
						{
							sendView('errorUpdatingNeighbours');
						}
						else
						{
							sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
						}
					}
				});
			}
			catch(e)
			{
				console.log(getCurrentTime()+'[Z] Error: '+e.message);
				
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}		
		});
		
	});
}

//treasureisle
function farmvilleGetZyngaVars(params, retry)
{
	if(typeof(retry) !== 'undefined')
	{
		var params2 = '_fb_noscript=1';
	}
	else
	{
		var params2 = '';
	}
	
	$.get('http://apps.facebook.com/onthefarm/', params2, function(data)
	{
		try
		{
			i1          =   data.indexOf('post_form_id:"')
			if (i1 == -1) throw {message:'Cannot post_form_id in page'}
			i1			+=	14;
			i2          =   data.indexOf('"',i1);
			
			params.post_form_id = data.slice(i1,i2);
			
			
			i1          =   data.indexOf('fb_dtsg:"',i1)
			if (i1 == -1) throw {message:'Cannot find fb_dtsg in page'}
			i1			+=	9;
			i2          = data.indexOf('"',i1);
			params.fb_dtsg		= data.slice(i1,i2);
		}
		catch(e)
		{
			console.log(getCurrentTime()+'[Z] Error: '+e.message);
			
			if(typeof(params.sendTo) == 'undefined')
			{
				sendView('errorUpdatingNeighbours');
			}
			else
			{
				sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
			}
		}
		
		var nextUrl = '';
		
		$('iframe', data).each(function()
		{
			var testData = $(this).attr('src');
			if(typeof(testData) == 'undefined')	 return;
			
			
			if(testData.indexOf('farmville.com/flash.php') != -1)
			{
				nextUrl = $(this).attr('src');
				return false;
			}
		});
		
		if(nextUrl == '')
		{
			if(typeof(retry) == 'undefined')
			{
				farmvilleGetZyngaVars(params, true);
			}
			else
			{
				sendView('errorUpdatingNeighbours');
			}
			return;
		}
		
		
		
		$.get(nextUrl, '', function(data){
			try
			{
				var re = new RegExp('^(?:f|ht)tp(?:s)?\://([^/]+)', 'im');
				var domain = nextUrl.match(re)[1].toString();
				
				var dataStr = '&';

				var i1 = data.indexOf('http://'+domain+'/stats_counter.php?');
				if (i1 == -1) throw {message:'Cannot post_form_id in page'}
				i1 += 47;
				i2 = data.indexOf('\'', i1);
				dataStr	+= data.slice(i1,i2);		
				
				
				params.zyParam = dataStr;
				
				
				console.log(getCurrentTime()+'[Z] Zynga params updated');

				$.get('http://'+domain+'/gifts_send.php?gift='+params.gift+'&view=farmville&src=direct&aff=&crt=&sendkey=&'+params.zyParam+'&overlayed=true&'+Math.round(new Date().getTime() / 1000)+'#overlay',  '', function(data)
				{
					try 
					{
						var i1,i2, myParms;
						var strTemp = data;

						i1       =  strTemp.indexOf('FB.init("');
						if (i1 == -1) throw {message:"Cannot find FB.init"}
						i1 += 9;
						i2       =  strTemp.indexOf('"',i1);

						myParms  =  'app_key='+strTemp.slice(i1,i2);
						i1     =  i2 +1;
						i1       =  strTemp.indexOf('"',i1)+1;
						i2       =  strTemp.indexOf('"',i1);
						
						myParms +=  '&channel_url='+ encodeURIComponent(strTemp.slice(i1,i2));

						i1       =  strTemp.indexOf('<fb:fbml>');
						i2       =  strTemp.indexOf('/script>',i1)-1;
						myParms +=  '&fbml='+encodeURIComponent(strTemp.slice(i1,i2));
						
						params.myParms = myParms;
						
						getFBML(params);
						
					}
					catch(e)
					{
						console.log(getCurrentTime()+'[Z] Error: '+e.message);
						if(typeof(params.sendTo) == 'undefined')
						{
							sendView('errorUpdatingNeighbours');
						}
						else
						{
							sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
						}
					}
				});
			}
			catch(e)
			{
				console.log(getCurrentTime()+'[Z] Error: '+e.message);
				
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}		
		});
	
	});
}


function frontiervilleGetZyngaVars(params, retry)
{
	$.ajax({
		type: "GET",
		url: 'http://apps.facebook.com/frontierville/?crt=&aff=tab&src=direct&newUser=&sendkey=&ref=tab',
		cache: false,
		headers: {
			'Accept':          'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
			'Accept-Language': 'en-us,en;q=0.5'                    
		},
		success: function(data)
		{
			try
			{
				var dataStr = '';

				i1  =   data.indexOf('zySnid=');
				if (i1 == -1) throw {message:'Cannot find zySnid in page'}
				i2  =   data.indexOf('&',i1);
				dataStr += data.slice(i1,i2)+'&';

				i1  =   data.indexOf('zySnuid=');
				if (i1 == -1) throw {message:'Cannot find zySnuid in page'}
				i2  =   data.indexOf('&',i1);
				dataStr += data.slice(i1,i2)+'&';

				i1  =   data.indexOf('zy_user=');
				if (i1 == -1) throw {message:'Cannot find zy_user in page'}
				i2  =   data.indexOf('&',i1);
				dataStr += data.slice(i1,i2)+'&';

				i1  =   data.indexOf('zy_ts=');
				if (i1 == -1) throw {message:'Cannot find zy_ts in page'}
				i2  =   data.indexOf('&',i1);
				dataStr += data.slice(i1,i2)+'&';

				i1  =   data.indexOf('zy_session=');
				if (i1 == -1) throw {message:'Cannot find zy_session in page'}
				i2  =   data.indexOf('&',i1);
				dataStr += data.slice(i1,i2)+'&';

				i1  =   data.indexOf('zySig=');
				if (i1 == -1) throw {message:'Cannot find zySig in page'}
				i2  =   data.indexOf('&',i1);
				dataStr += data.slice(i1,i2)+'&';
				
				params.zyParam = dataStr;
				
				console.log(getCurrentTime()+'[Z] Zynga params updated');

				i1          =   data.indexOf('post_form_id:"')
				if (i1 == -1) throw {message:'Cannot post_form_id in page'}
				i1			+=	14;
				i2          =   data.indexOf('"',i1);
				
				params.post_form_id = data.slice(i1,i2);

				i1          =   data.indexOf('fb_dtsg:"',i1)
				if (i1 == -1) throw {message:'Cannot find fb_dtsg in page'}
				i1			+=	9;
				i2          = data.indexOf('"',i1);
				params.fb_dtsg		= data.slice(i1,i2);
				
				frontiervilleGetFBMLinfo(params);
			}
			catch(e)
			{
				console.log(getCurrentTime()+'[Z] Error: '+e.message);
				
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}
		},
		error: function()
		{
			if(typeof(retry) == 'undefined')
			{
				frontiervilleGetZyngaVars(params, true);
			}
			else
			{
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}
		}
	});
}

function frontiervilleGetFBMLinfo(params, retry)
{
	$.ajax({
		type: "GET",
		url: 'http://fb-0.frontier.zynga.com/gifts_send.php?gift='+params.gift+'&view=farmville&src=direct&aff=&crt=&sendkey=&'+params.zyParam+'&overlayed=true&'+Math.round(new Date().getTime() / 1000)+'#overlay',
		headers: {
			'Accept':          'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
			'Accept-Language': 'en-us,en;q=0.5'
		},
		success: function(data)
		{
			try 
			{
				var i1,i2, myParms;
				var strTemp = data;

				i1       =  strTemp.indexOf('FB.init("');
				if (i1 == -1) throw {message:"Cannot find FB.init"}
				i1 += 9;
				i2       =  strTemp.indexOf('"',i1);

				myParms  =  'app_key='+strTemp.slice(i1,i2);
				i1     =  i2 +1;
				i1       =  strTemp.indexOf('"',i1)+1;
				i2       =  strTemp.indexOf('"',i1);
				
				myParms +=  '&channel_url='+ encodeURIComponent(strTemp.slice(i1,i2));

				i1       =  strTemp.indexOf('<fb:fbml>');
				i2       =  strTemp.indexOf('/script>',i1)-1;
				myParms +=  '&fbml='+encodeURIComponent(strTemp.slice(i1,i2));
				
				params.myParms = myParms;
				
				console.log(getCurrentTime()+'[Z] FBMLinfo - OK');
				
				getFBML(params);
			}
			catch(e)
			{
				console.log(getCurrentTime()+'[Z] Error: '+e.message);
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}
		},
		error: function()
		{
			if(typeof(retry) == 'undefined')
			{
				frontiervilleGetFBMLinfo(params, true);
			}
			else
			{
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}
		}
	});
}

function getFBML(params, retry)
{
	if(typeof(params.cafeUrl) != 'undefined')
	{
		var thisUrl = params.cafeUrl;
		var thisMethod = 'get';
	}
	else
	{
		var thisUrl = 'http://www.connect.facebook.com/widgets/serverfbml.php';
		var thisMethod = 'post';
	}

	$.ajax({
		type: thisMethod,
		url: thisUrl,
		cache: false,
		headers: {
			'Accept':           'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
			'Accept-Language':  'en-us,en;q=0.5',
			'Content-Type':     'application/x-www-form-urlencoded'
		},
		data: params.myParms,
		success: function(data)
		{		
			var i1,i2, myParms, strTemp2;
			var strTemp = data;
			
			try
			{
				i1       =  strTemp.indexOf('PlatformInvite.sendInvitation');
				if (i1 == -1) throw {message:"Cannot find PlatformInvite.sendInvitation in page"}
				i1       =  strTemp.indexOf('&#123;',i1);
				i2       =  strTemp.indexOf('&#125;',i1)+6;
				strTemp2     =  strTemp.slice(i1,i2);
				strTemp2   =  strTemp2.replace(/&quot;/g,'"').replace(/&#123;/g,'{').replace(/&#125;/g,'}');
				eval("aTemp = "+strTemp2);
				
				myParms      =  'app_id='     +aTemp["app_id"];
				myParms     +=  '&request_type='  +escape(aTemp["request_type"]);
				myParms     +=  '&invite='      +aTemp["invite"];

				if(typeof(params.cafeUrl) != 'undefined')
				{
					i1           =  strTemp.indexOf('.php" content="');
					if (i1 == -1) throw {message:"Cannot find  content=\\ in page"};
					i1			+=  15;
					i2           =  strTemp.indexOf('"',i1)-1;
					strTemp2    =   eval('"'+strTemp.slice(i1,i2)+'"');
					myParms     +=  '&content='     +encodeURIComponent(strTemp2);
					
				}
				else
				{
					i1           =  strTemp.indexOf('content=\\"');
					if (i1 == -1) throw {message:"Cannot find  content=\\ in page"};
					i1			+=  10;
					i2           =  strTemp.indexOf('"',i1)-1;
					strTemp2    =   eval('"'+strTemp.slice(i1,i2)+'"');
					myParms     +=  '&content='     +encodeURIComponent(strTemp2);
				}
				


				myParms     +=  '&preview=false';
				myParms     +=  '&is_multi='    +aTemp["is_multi"];
				myParms     +=  '&is_in_canvas='  +aTemp["is_in_canvas"];
				myParms     +=  '&form_id='     +aTemp["request_form"];
				myParms     +=  '&include_ci='    +aTemp["include_ci"];

				myParms     +=  '&prefill=true&message=&donot_send=false&__d=1';

				i1          =   strTemp.indexOf('name="post_form_id" value="');
				if (i1 == -1) throw {message:'Cannot find name="post_form_id" value=" in page'}
				i1 		   += 27
				i2          =   strTemp.indexOf('"',i1);
				myParms    +=  '&post_form_id='+strTemp.slice(i1,i2)

				if(typeof(params.cafeUrl) != 'undefined')
				{
					i1          =   strTemp.indexOf('fb_dtsg:"');
				}
				else
				{
					i1          =   strTemp.indexOf('fb_dtsg:"',i1);
				}
				
				if (i1 == -1) throw {message:'Cannot find fb_dtsg:" in page'}
				i1		   += 9;
				i2          =   strTemp.indexOf('"',i1);
				myParms     +=  '&fb_dtsg='+strTemp.slice(i1,i2);
				myParms     +=  '&post_form_id_source=AsyncRequest';
				
				
				i1          =   strTemp.indexOf('var items={',i1)+11;
				
				if (i1 == 10)
				{
					var slice = '';
				}
				else
				{
					i2 =   strTemp.indexOf('}};',i1)+1;
					var slice = strTemp.slice(i1,i2)
				}

				eval('var items = {'+ slice + '};');
				
				var tempParams = '';
				if(typeof(params.cafeUrl) != 'undefined')
				{
					$('form', data).each(function(){
						if( $(this).serialize().indexOf('cmfs_type') != -1)
						{
							tempParams = $(this).serialize()+'&';
							return false;
						}
					});
					
					myUrl2		= 'http://apps.facebook.com/cafeworld/send_request.php';
				}
				else
				{
					i1          =   strTemp.indexOf('<form action="')
					if (i1 == -1) throw {message:'Cannot find <form action=" in page'}
					i1			+=	14;
					i2          =   strTemp.indexOf('"',i1);
					myUrl2      =   strTemp.slice(i1,i2);
					myUrl2      =   myUrl2.replace(/&amp;/g,'&');
				}
				

				
				var param2 = '';

				params.items = items;
				
				if(typeof(params.sendTo) == 'undefined')
				{
					console.log(getCurrentTime()+'[Z] Updating neighbours');
					sendView('updateNeighbours', params.gameID, items);
					return;
				}
				
				console.log(getCurrentTime()+'[Z] Sending');
				
				
				var j = 0;
				for(u in params.sendTo)
				{
					var v = params.sendTo[u];
					
					myParms     +=  '&to_ids['+j+']='   +v;
					param2 += 'ids[]='+v+'&';
					
					if(typeof(params.cafeUrl) != 'undefined')
						tempParams += 'ids[]='+v+'&';
					
					j++;
				}
				param2 += 'cmfs_typeahead_'+aTemp["request_form"]+'=start';

				params.myParms = myParms;
				params.myUrl = myUrl2;
				params.param2 = param2;
				
				if(typeof(params.cafeUrl) != 'undefined')
				{
					params.param2 = tempParams;
				}
				
				console.log(params.param2);
				
				//console.log(params);
				
				
				sendGift(params);
			}
			catch(e)
			{
				console.log(getCurrentTime()+'[Z] Error: '+e.message);
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}
		},
		error: function()
		{
			if(typeof(retry) == 'undefined')
			{
				getFBML(params, true);
			}
			else
			{
				if(typeof(params.sendTo) == 'undefined')
				{
					sendView('errorUpdatingNeighbours');
				}
				else
				{
					sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				}
			}
		}
	});
}


function sendGift(params, retry)
{
	$.ajax({
		type: "POST",
		url: 'http://apps.facebook.com/fbml/ajax/prompt_send.php?__a=1',
		cache: false,
		dataType: 'text',
		data: params.myParms,
		success: function(data)
		{
			var str = data.substring(9);
			var str2 = parseInt(JSON.parse(str).error.toString());
			
			if(str2 > 0)
			{
				sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
				return;
			}
			
			if(typeof(params.cafeUrl) != 'undefined')
			{
				var reqMethod = 'GET';
			}
			else
			{
				var reqMethod = 'POST';
			}
			
			$.ajax({
				type: reqMethod,
				url: params.myUrl,
				dataType: 'text',
				data: params.param2,
				success: function(data)
				{
					var i = 0;
					var sendHistArr = {};
					
					var curTime = Math.round(new Date().getTime() / 1000);
					
					
					var found = false;
					
					for(u in params.items)
					{
						var v = params.items[u];
						if(jQuery.inArray(u, params.sendTo) > -1)
						{
							var sendHistory = {
								gift: params.gift,
								gameID: params.gameID,
								friend: v.name,
								time: curTime
							};
							database.addFreegift(params.gameID, v.name, params.gift, curTime, typeof(params.thankYou));
							
							if(typeof(params.thankYou) != 'undefined')
							{
								database.updateItemGiftBack((params.isRequest ? 'requests' : 'bonuses'), params.bonusID);
							}
							
							sendView('freegiftSuccess', sendHistory, (typeof(params.thankYou) != 'undefined' ? params.bonusID : ''));
							
							found = true;
							
							delete params.items[u];
							continue;
						}
						i++;
					}
					
					if(!found && typeof(params.thankYou) != 'undefined')
					{
						//thank you gift
						var sendHistory = {
							gift: params.gift,
							gameID: params.gameID,
							friend: params.sendToName,
							time: curTime
						};
						
						database.addFreegift(params.gameID, params.sendToName, params.gift, curTime, typeof(params.thankYou));
						database.updateItemGiftBack((params.isRequest ? 'requests' : 'bonuses'), params.bonusID);
						
						sendView('freegiftSuccess', sendHistory, (typeof(params.thankYou) != 'undefined' ? params.bonusID : ''));
					
					}		
					
					sendView('updateNeighbours', params.gameID, params.items);
				},
				error: function()
				{
					if(typeof(retry) == 'undefined')
					{
						sendGift(params, true);
					}
					else
					{
						sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
					}
				}
			});
		},
		error: function()
		{
			if(typeof(retry) == 'undefined')
			{
				sendGift(params, true);
			}
			else
			{
				sendView('errorWithSend', (typeof(params.thankYou) != 'undefined' ? params.bonusID : '') );
			}
		}
	});
}